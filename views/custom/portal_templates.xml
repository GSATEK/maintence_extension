<odoo>
    <data>
        <template id="portal_my_home_maintenance_orders" name="Show Maintenance Orders" customize_show="True" inherit_id="portal.portal_my_home" priority="50">
            <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Órdenes de Mantenimiento</t>
                    <t t-set="url" t-value="'/my/maintenance_orders'"/>
                    <t t-set="placeholder_count" t-value="'maintence_count'"/>
                </t>
            </xpath>
        </template>

        <template id="portal_my_maintenance_orders" name="My Maintenance Orders">
            <t t-call="portal.portal_layout">
                <t t-set="breadcrumbs_searchbar" t-value="True"/>
                <t t-call="portal.portal_searchbar">
                    <t t-set="title">Órdenes de Mantenimiento</t>
                </t>
                <div class="row mb-3">
                    <div class="col-3">
                        <strong>Filtrar por estado: </strong>
                        <select id="state_filter" class="form-control" onchange="window.location.href='?state=' + this.value">
                            <option value="">Todos los estados</option>
                            <t t-foreach="states" t-as="state">
                                <option t-att-value="state.id" t-att-selected="state.id == selected_state">
                                    <t t-esc="state.name"/>
                                </option>
                            </t>
                        </select>
                    </div>
                </div>
                <t t-if="not maintenance_orders">
                    <p>Actualmente usted no cuenta con órdenes de mantenimiento registradas.</p>
                </t>
                <t t-if="maintenance_orders">
                    <t t-call="portal.portal_table">
                        <table class="table rounded mb-0 bg-white o_portal_my_doc_table">
                            <thead>
                                <tr class="active">
                                    <th>Orden de mantenimiento</th>
                                    <th>Fecha</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="maintenance_orders" t-as="order">
                                    <tr>
                                        <td>
                                            <a t-attf-href="/my/maintenance_order/#{order.id}?access_token=#{order.access_token}&amp;{{ keep_query() }}">
                                                <span t-esc="order.name" t-att-title="order.id"/>
                                            </a>
                                        </td>
                                        <td><t t-esc="order.create_date" t-options="{'widget': 'date'}"/></td>
                                        <td><t t-esc="order.stage_id.name"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </t>
                </t>
            </t>
        </template>

        <template id="portal_my_maintenance_order" name="My Maintenance Order">
            <t t-call="portal.portal_layout">
                <t t-call="portal.portal_record_layout">
                    <t t-set="card_header">
                        <div class="card-header bg-white">
                            <div class="col-12">
                                <h5 class="d-flex mb-1 mb-md-0 row">
                                    <div class="col-9">
                                        <strong>Orden de mantenimiento:</strong>
                                        <input type="text" t-att-value="maintenance_order.name" name="name" class="form-control" readonly="readonly"/>
                                    </div>
                                </h5>
                            </div>
                        </div>
                    </t>
                    <t t-set="card_body">
                        <form action="/my/maintenance_order/update" method="post">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <input type="hidden" name="id" t-att-value="maintenance_order.id"/>
                            <div class="row container">
                                <div class="col-6 col-md-6">
                                    <div><strong>Estado: </strong>
                                        <select name="stage_id" class="form-control">
                                            <t t-foreach="maintenance_order.stage_id.search([])" t-as="stage">
                                                <option t-att-value="stage.id" t-att-selected="stage.id == maintenance_order.stage_id.id">
                                                    <t t-esc="stage.name"/>
                                                </option>
                                            </t>
                                        </select>
                                    </div>
                                    <div style="margin-top: 30px; margin-bottom: 30px;"><strong>Fecha de peticion: </strong><input type="date" t-att-value="maintenance_order.request_date" name="request_date" class="form-control"/></div>
                                </div>
                                <div class="col-6 col-md-6">
                                    <div><strong>Horas Invertidas: </strong><input type="number" t-att-value="maintenance_order.duration" name="duration" class="form-control"/></div>
                                </div>
                            </div>
                            <div class="row container">
                                <div class="col-12">
                                    <div><strong>Trabajos realizados: </strong><textarea name="work_done" class="form-control"><t t-esc="maintenance_order.work_done"/></textarea></div>
                                    <div><strong>Materiales usados: </strong><textarea name="materials_used" class="form-control"><t t-esc="maintenance_order.materials_used"/></textarea></div>
                                    <div><strong>Observaciones: </strong><textarea name="observations" class="form-control"><t t-esc="maintenance_order.observations"/></textarea></div>
                                </div>
                            </div>
                            <div class="row container" style="margin-top: 30px; margin-bottom: 30px;">
                                <div class="col-12">
                                    <h5>Tareas</h5>
                                    <t t-foreach="maintenance_order.task_ids" t-as="task">
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <t t-esc="task.name"/>
                                            </div>
                                            <div class="col-6" style="display:flex; align-items: center;">
                                                <label class="form-check-label" style="margin-right: 10px;">Realizado</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" t-att-name="'state_' + str(task.id)" t-att-checked="task.state == 'realizado'"/>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                            <div class="signature-container" style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>Firma trabajador: </strong>
                                    <div class="signature-field" style="border-bottom: 1px solid #000; margin-bottom: 30px;">
                                        <span t-field="maintenance_order.worker_signature" t-options='{"widget": "image", "size": (300, 100)}'/>
                                    </div>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalaccept">
                                        Firmar trabajador
                                    </button>
                                </div>
                                <div>
                                    <strong>Firma cliente: </strong>
                                    <div class="signature-field" style="border-bottom: 1px solid #000; margin-bottom: 30px;">
                                        <span t-field="maintenance_order.client_signature" t-options='{"widget": "image", "size": (300, 100)}'/>
                                    </div>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalaccept">
                                        Firmar cliente
                                    </button>
                                </div>
                            </div>
                            <div class="row container mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">Guardar</button>
                                </div>
                            </div>
                        </form>
                    </t>
                </t>
            </t>
            <div role="dialog" class="modal fade" id="modalaccept">
                <div class="modal-dialog">
                    <form id="accept" method="POST" t-att-data-maintenance-id="maintenance_order.id" class="js_accept_json modal-content js_website_submit_form">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <header class="modal-header">
                            <h4 class="modal-title">Firmar Orden de Mantenimiento</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </header>
                        <main class="modal-body" id="sign-dialog">
                            <p>
                                <span>Firmando conforme al trabajador</span>
                                <ul>
                                    <li>
                                        <span>Firmando la orden de mantenimiento </span> <b t-field="maintenance_order.name"/>
                                    </li>
                                </ul>
                            </p>
                            <t t-call="portal.signature_form">
                                <t t-set="call_url" t-value="'/my/maintenance_order/worker/sign/' + str(maintenance_order.id)"/>
                            </t>
                        </main>
                    </form>
                </div>
            </div>
        </template>
    </data>
</odoo>